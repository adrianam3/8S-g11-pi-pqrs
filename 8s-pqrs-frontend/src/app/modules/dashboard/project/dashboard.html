<div class="dashboard-page">
  <p-toolbar class="mb-3 surface-card shadow-1 border-round toolbar-sticky">
    <div class="p-toolbar-group-left gap-2 flex align-items-center flex-wrap">
      <span class="mr-2">Inicio:</span>
      <p-date-picker [(ngModel)]="startDate" dateFormat="yy-mm-dd" [showIcon]="true"></p-date-picker>

      <span class="ml-3 mr-2">Fin:</span>
      <p-date-picker [(ngModel)]="endDate" dateFormat="yy-mm-dd" [showIcon]="true"></p-date-picker>

      <span class="ml-3 mr-2">Periodo:</span>
      <p-select [options]="periodos" [(ngModel)]="period" optionLabel="label" optionValue="value"
        (onChange)="onPeriodoChange()"></p-select>

      <span class="ml-3 mr-2">Segmento:</span>
      <p-select [options]="segmentos" [(ngModel)]="segment" optionLabel="label" optionValue="value"
        (onChange)="onSegmentChange()"></p-select>

      <button pButton label="Actualizar" icon="pi pi-refresh" class="ml-3" (click)="refresh()" type="button"></button>
    </div>
  </p-toolbar>

  <p-tabs [(value)]="selectedTabIndex" (valueChange)="onTabChange($event)" class="tabs-compact">
    <p-tablist>
      <button p-tab [value]="0" type="button" (click)="onTabChange(0)"
        [ngClass]="{ 'is-active': selectedTabIndex === 0 }">
        <i class="pi pi-chart-bar mr-2"></i>Encuestas
      </button>
      <button p-tab [value]="1" type="button" (click)="onTabChange(1)"
        [ngClass]="{ 'is-active': selectedTabIndex === 1 }">
        <i class="pi pi-star mr-2"></i>Satisfacción
      </button>
      <button p-tab [value]="2" type="button" (click)="onTabChange(2)"
        [ngClass]="{ 'is-active': selectedTabIndex === 2 }">
        <i class="pi pi-inbox mr-2"></i>PQRs
      </button>
      <button p-tab [value]="3" type="button" (click)="onTabChange(3)"
        [ngClass]="{ 'is-active': selectedTabIndex === 3 }">
        <i class="pi pi-chart-line mr-2"></i>Evolución
      </button>
      <button p-tab [value]="4" type="button" (click)="onTabChange(4)"
        [ngClass]="{ 'is-active': selectedTabIndex === 4 }">
        <i class="pi pi-gauge mr-2"></i>NPS
      </button>
    </p-tablist>

    <p-tabpanels>
      <!-- ========== 0: ENCUESTAS ========== -->
      <p-tabpanel [value]="0">
        <div class="grid">
          <div class="col-12 md:col-3">
            <p-card class="eq-card kpi-card">
              <div class="kpi-header" pTooltip="Encuestas programadas en el período" tooltipPosition="top">
                <i class="pi pi-calendar kpi-icon kpi-blue"></i>
                <span>Programadas</span>
              </div>
              <div class="kpi">{{ encuestasResumen?.programadas ?? 0 }}</div>
            </p-card>
          </div>

          <div class="col-12 md:col-3">
            <p-card class="eq-card kpi-card">
              <div class="kpi-header" pTooltip="Encuestas enviadas" tooltipPosition="top">
                <i class="pi pi-envelope kpi-icon kpi-indigo"></i>
                <span>Enviadas</span>
              </div>
              <div class="kpi">{{ encuestasResumen?.enviadas ?? 0 }}</div>
            </p-card>
          </div>

          <div class="col-12 md:col-3">
            <p-card class="eq-card kpi-card">
              <div class="kpi-header" pTooltip="Encuestas con al menos una respuesta" tooltipPosition="top">
                <i class="pi pi-check-circle kpi-icon kpi-green"></i>
                <span>Respondidas</span>
              </div>
              <div class="kpi">{{ encuestasResumen?.respondidas ?? 0 }}</div>
            </p-card>
          </div>

          <div class="col-12 md:col-3">
            <p-card class="eq-card kpi-card">
              <div class="kpi-header" pTooltip="Tasa de respuesta = Respondidas / Enviadas" tooltipPosition="top">
                <i class="pi pi-chart-line kpi-icon kpi-teal"></i>
                <span>Tasa Respuesta</span>
              </div>
              <div class="kpi">{{ (encuestasResumen?.tasa_pct ?? 0) | number:'1.0-0' }}%</div>
            </p-card>
          </div>
        </div>
        <div class="grid">

          <!-- Fila: Detalle por Segmento (dos columnas 50/50) -->
          <div class="grid equalize-cards">
            <!-- Izquierda: CANAL -->
            <div class="col-12 md:col-6 eq-col">
              <p-card header="Detalle por Canal" class="eq-card fill-card">
                <p-table #tblCanal [value]="encuestasPorCanal" responsiveLayout="scroll" class="seg-table">
                  <ng-template pTemplate="header">
                    <tr>
                      <th>Segmento</th>
                      <th class="text-right">Programadas</th>
                      <th class="text-right">Enviadas</th>
                      <th class="text-right">Respondidas</th>
                      <th class="text-right">Tasa %</th>
                    </tr>
                  </ng-template>
                  <ng-template pTemplate="body" let-r>
                    <tr>
                      <td class="seg-name">{{ r.segmento }}</td>
                      <td class="num">{{ r.programadas }}</td>
                      <td class="num">{{ r.enviadas }}</td>
                      <td class="num">{{ r.respondidas }}</td>
                      <td class="num"><span [ngClass]="pctBadgeClass(r.tasa_pct)">{{ fmtPct(r.tasa_pct) }}</span></td>
                    </tr>
                  </ng-template>
                  <ng-template pTemplate="footer">
                    <tr class="totals-row">
                      <td class="seg-name">Total</td>
                      <td class="num">{{ totalAgencia.programadas }}</td>
                      <td class="num">{{ totalAgencia.enviadas }}</td>
                      <td class="num">{{ totalAgencia.respondidas }}</td>
                      <td class="num">
                        <span [ngClass]="pctBadgeClass(totalAgencia.tasa_pct)">{{ fmtPct(totalAgencia.tasa_pct)
                          }}</span>
                      </td>
                    </tr>
                  </ng-template>
                </p-table>
              </p-card>
            </div>

            <!-- Derecha: AGENCIA -->
            <div class="col-12 md:col-6 eq-col">
              <p-card header="Detalle por Agencia" class="eq-card fill-card">
                <p-table #tblAgencia [value]="encuestasPorAgencia" responsiveLayout="scroll" class="seg-table">
                  <ng-template pTemplate="header">
                    <tr>
                      <th>Segmento</th>
                      <th class="text-right">Programadas</th>
                      <th class="text-right">Enviadas</th>
                      <th class="text-right">Respondidas</th>
                      <th class="text-right">Tasa %</th>
                    </tr>
                  </ng-template>
                  <ng-template pTemplate="body" let-r>
                    <tr>
                      <td class="seg-name">{{ r.segmento }}</td>
                      <td class="num">{{ r.programadas }}</td>
                      <td class="num">{{ r.enviadas }}</td>
                      <td class="num">{{ r.respondidas }}</td>
                      <td class="num"><span [ngClass]="pctBadgeClass(r.tasa_pct)">{{ fmtPct(r.tasa_pct) }}</span></td>
                    </tr>
                  </ng-template>

                  <ng-template pTemplate="footer">
                    <tr class="totals-row">
                      <td class="seg-name">Total</td>
                      <td class="num">{{ totalCanal.programadas }}</td>
                      <td class="num">{{ totalCanal.enviadas }}</td>
                      <td class="num">{{ totalCanal.respondidas }}</td>
                      <td class="num">
                        <span [ngClass]="pctBadgeClass(totalCanal.tasa_pct)">{{ fmtPct(totalCanal.tasa_pct) }}</span>
                      </td>
                    </tr>
                  </ng-template>

                </p-table>
              </p-card>
            </div>
          </div>
        </div>


        <div class="col-12">
          <p-card header="Matriz de encuestas (Encuesta / Canal / Agencia)" class="eq-card">
            <p-table [value]="encuestasMatriz" responsiveLayout="scroll" class="seg-table">
              <ng-template pTemplate="header">
                <tr>
                  <th>Encuesta</th>
                  <th>Canal</th>
                  <th>Agencia</th>
                  <th>Estado envío</th>
                  <th class="text-right">Programadas</th>
                  <th class="text-right">Enviadas</th>
                  <th class="text-right">Respondidas</th>
                  <th class="text-right">Tasa %</th>
                </tr>
              </ng-template>
              <ng-template pTemplate="body" let-r>
                <tr>
                  <td>{{ r.encuesta }}</td>
                  <td>{{ r.canal }}</td>
                  <td>{{ r.agencia }}</td>
                  <td>{{ r.estadoEnvio }}</td>
                  <td class="num">{{ r.programadas }}</td>
                  <td class="num">{{ r.enviadas }}</td>
                  <td class="num">{{ r.respondidas }}</td>
                  <td class="num"><span [ngClass]="pctBadgeClass(r.tasa_pct)">{{ fmtPct(r.tasa_pct) }}</span></td>
                </tr>
              </ng-template>
              <ng-template pTemplate="footer">
                <tr>
                  <td colspan="4" class="text-right"><strong>Totales</strong></td>
                  <td class="num"><strong>{{ encuestasMatrizTotals.programadas }}</strong></td>
                  <td class="num"><strong>{{ encuestasMatrizTotals.enviadas }}</strong></td>
                  <td class="num"><strong>{{ encuestasMatrizTotals.respondidas }}</strong></td>
                  <td class="num">
                    <span [ngClass]="pctBadgeClass(encuestasMatrizTotals.tasa_pct)">
                      {{ fmtPct(encuestasMatrizTotals.tasa_pct) }}
                    </span>
                  </td>
                </tr>
              </ng-template>
            </p-table>
          </p-card>
        </div>




      </p-tabpanel>

      <!-- ========== 1: SATISFACCIÓN ========== -->
      <p-tabpanel [value]="1">
        <div class="grid">
          <!-- KPIs con icono + tooltip -->
          <div class="col-12 sm:col-6 lg:col-3">
            <p-card class="eq-card kpi-card">
              <ng-template pTemplate="header">
                <div class="kpi-header" pTooltip="Porcentaje de satisfechos (4–5) en preguntas no NPS/CES"
                  tooltipPosition="top">
                  <i class="pi pi-thumbs-up kpi-icon kpi-green"></i>
                  <span>CSAT (%)</span>
                </div>
              </ng-template>
              <div class="kpi">{{ kpis?.csat ?? 0 }}%</div>
            </p-card>
          </div>

          <div class="col-12 sm:col-6 lg:col-3">
            <p-card class="eq-card kpi-card">
              <ng-template pTemplate="header">
                <div class="kpi-header" pTooltip="Net Promoter Score (Promotores − Detractores)" tooltipPosition="top">
                  <i class="pi pi-bullseye kpi-icon kpi-indigo"></i>
                  <span>NPS</span>
                </div>
              </ng-template>
              <div class="kpi">{{ kpis?.nps ?? 0 }}</div>
              <div class="muted">
                P {{ kpis?.nps_breakdown?.promotores_pct ?? 0 }}% ·
                Pa {{ kpis?.nps_breakdown?.pasivos_pct ?? 0 }}% ·
                D {{ kpis?.nps_breakdown?.detractores_pct ?? 0 }}%
              </div>
            </p-card>
          </div>

          <div class="col-12 sm:col-6 lg:col-3">
            <p-card class="eq-card kpi-card">
              <ng-template pTemplate="header">
                <div class="kpi-header" pTooltip="Customer Effort Score promedio (1–5)" tooltipPosition="top">
                  <i class="pi pi-sliders-h kpi-icon kpi-blue"></i>
                  <span>CES (1–5)</span>
                </div>
              </ng-template>
              <div class="kpi">{{ kpis?.ces ?? 0 }}</div>
            </p-card>
          </div>

          <div class="col-12 sm:col-6 lg:col-3">
            <p-card class="eq-card kpi-card">
              <ng-template pTemplate="header">
                <div class="kpi-header" pTooltip="Promedio de satisfacción (1–5) en preguntas no NPS/CES"
                  tooltipPosition="top">
                  <i class="pi pi-smile kpi-icon kpi-teal"></i>
                  <span>Satisfacción (1–5)</span>
                </div>
              </ng-template>
              <div class="kpi">{{ overview?.satisfaccion_avg_10?.value ?? 0 }}</div>
              <p-progressBar *ngIf="overview?.satisfaccion_avg_10"
                [value]="((overview?.satisfaccion_avg_10?.value ?? 0) * 10)"></p-progressBar>
              <div class="muted" *ngIf="overview?.satisfaccion_avg_10?.delta_abs_vs_prev !== null">
                Δ {{ ((overview?.satisfaccion_avg_10?.delta_abs_vs_prev ?? 0) > 0 ? '+' : '') }}
                {{ (overview?.satisfaccion_avg_10?.delta_abs_vs_prev ?? 0) }}
              </div>
            </p-card>
          </div>

          <!-- Por segmento -->
          <div class="col-12 lg:col-6">
            <p-card header="CSAT por {{ segment }}" class="eq-card">
              <div class="chart-holder chart-240">
                <p-chart *ngIf="csatSegBar" type="bar" [data]="csatSegBar" [options]="csatBarOptions"></p-chart>
              </div>
            </p-card>
          </div>

          <div class="col-12 lg:col-6">
            <p-card header="NPS por {{ segment }}" class="eq-card">
              <div class="chart-holder chart-240">
                <p-chart *ngIf="npsSegBar" type="bar" [data]="npsSegBar" [options]="npsBarOptions"></p-chart>
              </div>
            </p-card>
          </div>

          <div class="col-12 lg:col-6">
            <p-card header="CES por {{ segment }}" class="eq-card">
              <div class="chart-holder chart-240">
                <p-chart *ngIf="cesSegBar" type="bar" [data]="cesSegBar" [options]="cesBarOptions"></p-chart>
              </div>
            </p-card>
          </div>

          <!-- Tendencia y Dona -->
          <div class="col-12 xl:col-8">
            <p-card header="Tendencia: Satisfacción (1–5) y PQRs" class="eq-card">
              <div class="chart-holder chart-300">
                <ng-container *ngIf="lineData; else noTrend">
                  <p-chart type="bar" [data]="lineData" [options]="lineOptions"></p-chart>
                </ng-container>
              </div>
            </p-card>
          </div>

          <div class="col-12 xl:col-4">
            <p-card header="Distribución de calificaciones (1–5)" class="eq-card">
              <div class="chart-holder chart-300">
                <ng-container *ngIf="hasDonutData(); else noDonut">
                  <p-chart type="doughnut" [data]="donutData" [options]="donutOptions"></p-chart>
                </ng-container>
              </div>
            </p-card>
          </div>

          <ng-template #noTrend>
            <div class="empty-state">Sin datos para el período seleccionado</div>
          </ng-template>
          <ng-template #noDonut>
            <div class="empty-state">Sin datos para el período seleccionado</div>
          </ng-template>
        </div>
      </p-tabpanel>

      <!-- ========== 2: PQRs ========== -->
      <p-tabpanel [value]="2">
        <div class="grid">

          <!-- KPIs PQRs: 5 en la primera fila -->
          <div class="col-12">
            <div class="kpi-row kpi-5">
              <p-card class="eq-card kpi-card kpi-mini">
                <ng-template pTemplate="header">
                  <div class="kpi-header" pTooltip="Total de PQRs creadas en el período" tooltipPosition="top">
                    <i class="pi pi-inbox kpi-icon kpi-indigo"></i>
                    <span>Total PQRs</span>
                  </div>
                </ng-template>
                <div class="kpi">{{ pqrsResumen?.total ?? overview?.total_pqrs?.value ?? 0 }}</div>
                <div class="muted">Δ {{ overview?.total_pqrs?.delta_pct_vs_prev ?? 0 }}%</div>
              </p-card>

              <p-card class="eq-card kpi-card kpi-mini">
                <ng-template pTemplate="header">
                  <div class="kpi-header" pTooltip="PQRs no resueltas (no cerradas)" tooltipPosition="top">
                    <i class="pi pi-info-circle kpi-icon kpi-blue"></i>
                    <span>PQRs abiertas</span>
                  </div>
                </ng-template>
                <div class="kpi">{{ pqrsResumen?.abiertos ?? overview?.pqrs_abiertas?.value ?? 0 }}</div>
                <div class="muted">Δ {{ overview?.pqrs_abiertas?.delta_pct_vs_prev ?? 0 }}%</div>
              </p-card>

              <p-card class="eq-card kpi-card kpi-mini">
                <ng-template pTemplate="header">
                  <div class="kpi-header" pTooltip="PQRs en trámite" tooltipPosition="top">
                    <i class="pi pi-refresh kpi-icon kpi-teal"></i>
                    <span>En proceso</span>
                  </div>
                </ng-template>
                <div class="kpi">{{ pqrsResumen?.en_proceso ?? 0 }}</div>
              </p-card>

              <p-card class="eq-card kpi-card kpi-mini">
                <ng-template pTemplate="header">
                  <div class="kpi-header" pTooltip="PQRs escaladas" tooltipPosition="top">
                    <i class="pi pi-arrow-up-right kpi-icon kpi-purple"></i>
                    <span>Escaladas</span>
                  </div>
                </ng-template>
                <div class="kpi">{{ pqrsResumen?.escalados ?? 0 }}</div>
              </p-card>

              <p-card class="eq-card kpi-card kpi-mini">
                <ng-template pTemplate="header">
                  <div class="kpi-header" pTooltip="PQRs cerradas o resueltas" tooltipPosition="top">
                    <i class="pi pi-check-circle kpi-icon kpi-green"></i>
                    <span>Cerradas</span>
                  </div>
                </ng-template>
                <div class="kpi">{{ pqrsResumen?.cerrados ?? 0 }}</div>
              </p-card>
            </div>
          </div>


          <p-divider class="col-12" type="solid"></p-divider>

          <div class="col-12 md:col-6">
            <p-card header="PQRs por estado">
              <div style="height:260px">
                <!-- <p-chart type="bar" [data]="pqrsEstadoData" [options]="{ responsive:true, maintainAspectRatio:false }" -->
                <p-chart type="bar" [data]="pqrsEstadoData" [options]="pqrsEstadoOpts" *ngIf="pqrsEstadoData"></p-chart>
              </div>
            </p-card>
          </div>

          <div class="col-12 md:col-6">
            <p-card header="PQRs por categoría">
              <p-table [value]="pqrsCat" [paginator]="true" [rows]="5" responsiveLayout="scroll">
                <ng-template pTemplate="header">
                  <tr>
                    <th>Categoría</th>
                    <th style="width:120px">Total</th>
                  </tr>
                </ng-template>
                <ng-template pTemplate="body" let-r>
                  <tr>
                    <td>{{ r.categoria }}</td>
                    <td class="text-right">{{ r.total }}</td>
                  </tr>
                </ng-template>
              </p-table>
            </p-card>
          </div>

          <div class="col-12">
            <p-card header="PQRs por categoría padre">
              <p-table [value]="pqrsCatPadre" [paginator]="true" [rows]="5" responsiveLayout="scroll">
                <ng-template pTemplate="header">
                  <tr>
                    <th>Categoría padre</th>
                    <th style="width:120px">Total</th>
                  </tr>
                </ng-template>
                <ng-template pTemplate="body" let-r>
                  <tr>
                    <td>{{ r.categoria_padre }}</td>
                    <td class="text-right">{{ r.total }}</td>
                  </tr>
                </ng-template>
              </p-table>
            </p-card>
          </div>
        </div>
      </p-tabpanel>

      <!-- ========== 3: EVOLUCIÓN ========== -->
      <p-tabpanel [value]="3">
        <div class="grid">
          <div class="col-12 lg:col-6">
            <p-card header="CSAT (serie)" class="eq-card">
              <div class="chart-holder chart-300">
                <ng-container *ngIf="seriesCsat; else noSeries">
                  <p-chart type="line" [data]="seriesCsat" [options]="seriesLineOpts"></p-chart>
                </ng-container>
              </div>
            </p-card>
          </div>

          <div class="col-12 lg:col-6">
            <p-card header="NPS (serie)" class="eq-card">
              <div class="chart-holder chart-300">
                <ng-container *ngIf="seriesNps; else noSeries">
                  <p-chart type="line" [data]="seriesNps" [options]="seriesLineOpts"></p-chart>
                </ng-container>
              </div>
            </p-card>
          </div>

          <div class="col-12 lg:col-6">
            <p-card header="CES (serie)" class="eq-card">
              <div class="chart-holder chart-300">
                <ng-container *ngIf="seriesCes; else noSeries">
                  <p-chart type="line" [data]="seriesCes" [options]="seriesLineOpts"></p-chart>
                </ng-container>
              </div>
            </p-card>
          </div>

          <div class="col-12 lg:col-6">
            <p-card header="PQRs (serie)" class="eq-card">
              <div class="chart-holder chart-300">
                <ng-container *ngIf="seriesPqrs; else noSeries">
                  <p-chart type="line" [data]="seriesPqrs" [options]="seriesLineOpts"></p-chart>
                </ng-container>
              </div>
            </p-card>
          </div>

          <div class="col-12">
            <p-card header="Correlación: Satisfacción (1–5) vs PQRs" class="eq-card">
              <div class="chart-holder chart-300">
                <ng-container *ngIf="seriesCorr; else noSeries">
                  <p-chart type="bar" [data]="seriesCorr" [options]="seriesMixOpts"></p-chart>
                </ng-container>
              </div>
            </p-card>
          </div>
        </div>

        <ng-template #noSeries>
          <div class="empty-state">Sin datos para el período seleccionado</div>
        </ng-template>
      </p-tabpanel>


      <!-- ========== 4: NPS (gauge) ========== -->
      <p-tabpanel [value]="4">
        <div class="grid nps-eq-row">
          <!-- Izquierda: Gauge -->
          <div class="col-12 lg:col-6">
            <p-card header="NPS (−100 a 100)" class="eq-card h-100">
              <div class="chart-holder chart-300">
                <p-chart type="doughnut" [data]="npsGaugeData" [options]="npsGaugeOptions"></p-chart>
              </div>
            </p-card>
          </div>

          <!-- Derecha: Detalle -->
          <div class="col-12 lg:col-6">
            <p-card header="Detalle NPS" class="eq-card h-100 nps-detail-card">
              <div class="nps-header">
                <div class="nps-subtitle">NPS<br><small>Promotores – Detractores</small></div>
                <div class="nps-score">{{ kpis?.nps ?? 0 }}</div>
              </div>

              <div class="nps-list">
                <div class="nps-item">
                  <div class="row">
                    <span>Promotores</span>
                    <span class="pct">{{ kpis?.nps_breakdown?.promotores_pct ?? 0 }}%</span>
                  </div>
                  <p-progressBar class="nps-bar"
                    [ngStyle]="barStyle(promColor(kpis?.nps_breakdown?.promotores_pct ?? 0))"
                    [value]="kpis?.nps_breakdown?.promotores_pct ?? 0"></p-progressBar>
                </div>

                <div class="nps-item">
                  <div class="row">
                    <span>Pasivos</span>
                    <span class="pct">{{ kpis?.nps_breakdown?.pasivos_pct ?? 0 }}%</span>
                  </div>
                  <p-progressBar class="nps-bar"
                    [ngStyle]="barStyle(pasivoColor(kpis?.nps_breakdown?.pasivos_pct ?? 0))"
                    [value]="kpis?.nps_breakdown?.pasivos_pct ?? 0"></p-progressBar>
                </div>

                <div class="nps-item">
                  <div class="row">
                    <span>Detractores</span>
                    <span class="pct">{{ kpis?.nps_breakdown?.detractores_pct ?? 0 }}%</span>
                  </div>
                  <p-progressBar class="nps-bar"
                    [ngStyle]="barStyle(detrColor(kpis?.nps_breakdown?.detractores_pct ?? 0))"
                    [value]="kpis?.nps_breakdown?.detractores_pct ?? 0"></p-progressBar>
                </div>
              </div>
            </p-card>
          </div>
        </div>



        <!-- aqui -->
        <!-- ====== (A) NPS por Encuesta / Canal / Agencia / Asesor ====== -->
        <div class="col-12">
          <p-card header="NPS por Encuesta / Canal / Agencia / Asesor" class="eq-card">
            <div class="flex align-items-center gap-2 mb-3">
              <!-- Filtro opcional por idEncuesta -->
              <input type="number" min="0" class="p-inputtext p-component w-10rem" placeholder="idEncuesta (opcional)"
                [(ngModel)]="filtroIdEncuesta">
              <button pButton type="button" label="Aplicar" icon="pi pi-filter" (click)="loadNpsExtra()"></button>
            </div>

            <p-table [value]="npsEntidadRows" [paginator]="true" [rows]="10" responsiveLayout="scroll">
              <ng-template pTemplate="header">
                <tr>
                  <th>Encuesta</th>
                  <th>Canal</th>
                  <th>Agencia</th>
                  <th>Asesor</th>
                  <th class="text-right">Total NPS</th>
                  <th class="text-right">Promotores %</th>
                  <th class="text-right">Pasivos %</th>
                  <th class="text-right">Detractores %</th>
                  <th class="text-right">NPS</th>
                </tr>
              </ng-template>
              <ng-template pTemplate="body" let-r>
                <tr>
                  <td>{{ r.encuesta }}</td>
                  <td>{{ r.canal }}</td>
                  <td>{{ r.agencia }}</td>
                  <td>{{ r.asesor }}</td>
                  <td class="text-right">{{ r.total_nps }}</td>
                  <td class="text-right"><span class="badge badge-green">{{ r.promotores_pct | number:'1.0-0' }}%</span>
                  </td>
                  <td class="text-right"><span class="badge badge-amber">{{ r.pasivos_pct | number:'1.0-0' }}%</span>
                  </td>
                  <td class="text-right"><span class="badge badge-red">{{ r.detractores_pct | number:'1.0-0' }}%</span>
                  </td>
                  <td class="text-right"><span [ngClass]="npsClass(r.nps)">{{ r.nps | number:'1.0-0' }}</span></td>
                </tr>
              </ng-template>
            </p-table>
          </p-card>
        </div>

        <!-- ====== (B) NPS – Detalle de clientes ====== -->
        <div class="col-12">
          <p-card header="NPS – Detalle de clientes" class="eq-card">
            <p-table [value]="npsClientesRows" [paginator]="true" [rows]="10" responsiveLayout="scroll">
              <ng-template pTemplate="header">
                <tr>
                  <th>Encuesta</th>
                  <th>Canal</th>
                  <th>Agencia</th>
                  <th>Asesor</th>
                  <th>Cliente</th>
                  <th>Celular</th>
                  <th>Email</th>
                  <th class="text-right">NPS (prom.)</th>
                  <th class="text-center">Clasificación</th>
                </tr>
              </ng-template>
              <ng-template pTemplate="body" let-r>
                <tr>
                  <td>{{ r.encuesta }}</td>
                  <td>{{ r.canal }}</td>
                  <td>{{ r.agencia }}</td>
                  <td>{{ r.asesor }}</td>
                  <td>{{ r.cliente }}</td>
                  <td>{{ r.celular }}</td>
                  <td>{{ r.email }}</td>
                  <td class="text-right">{{ r.nps_val ?? '-' }}</td>
                  <td class="text-center">
                    <span [ngClass]="clasifClass(r.clasificacion_nps)">{{ r.clasificacion_nps }}</span>
                  </td>
                </tr>
              </ng-template>
            </p-table>
          </p-card>
        </div>





      </p-tabpanel>






    </p-tabpanels>
  </p-tabs>
</div>